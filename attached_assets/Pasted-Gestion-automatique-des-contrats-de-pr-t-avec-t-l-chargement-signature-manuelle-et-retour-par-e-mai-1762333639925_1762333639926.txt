Gestion automatique des contrats de pr√™t avec t√©l√©chargement, signature manuelle et retour par e-mail
‚öôÔ∏è Stack technique

Backend : FastAPI (h√©berg√© sur Render)

Base de donn√©es : PostgreSQL

Frontend : React (h√©berg√© sur Vercel)

Stockage des fichiers : AWS S3 (ou √©quivalent compatible S3)

Envoi d‚Äôe-mails : SMTP (Mailgun, SendGrid, Postmark ou serveur e-mail gratuit)

üéØ Objectif fonctionnel

L‚Äôutilisateur cr√©e une demande de pr√™t via le site.

L‚Äôadministrateur ou le syst√®me valide la demande.

Une fois valid√©e :

Le contrat de pr√™t est g√©n√©r√© automatiquement (√† partir d‚Äôun mod√®le HTML ‚Üí PDF).

Le fichier est enregistr√© sur S3 et un lien est cr√©√©.

Le client voit le contrat dans son dashboard et peut le t√©l√©charger.

Le client signe le document manuellement (papier ou outil PDF).

Il renvoie le document sign√© par e-mail (adresse d√©di√©e ou formulaire d‚Äôupload).

L‚Äôadministrateur re√ßoit le contrat sign√©, qui peut √™tre archiv√© et visible dans le dashboard.

üóÉÔ∏è Structure de la base PostgreSQL
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(255) UNIQUE,
  password_hash TEXT,
  role VARCHAR(20) DEFAULT 'client'
);

CREATE TABLE loans (
  id SERIAL PRIMARY KEY,
  user_id INT REFERENCES users(id),
  amount NUMERIC(12,2),
  rate NUMERIC(5,2),
  duration_months INT,
  status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, signed
  contract_url TEXT,
  signed_contract_url TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

üß© Backend ‚Äî FastAPI

Dossiers recommand√©s :

/app
 ‚îú‚îÄ‚îÄ main.py
 ‚îú‚îÄ‚îÄ models.py
 ‚îú‚îÄ‚îÄ routes/
 ‚îÇ    ‚îú‚îÄ‚îÄ loans.py
 ‚îÇ    ‚îú‚îÄ‚îÄ auth.py
 ‚îú‚îÄ‚îÄ services/
 ‚îÇ    ‚îú‚îÄ‚îÄ contract_generator.py
 ‚îÇ    ‚îú‚îÄ‚îÄ s3_storage.py
 ‚îÇ    ‚îú‚îÄ‚îÄ mailer.py
 ‚îî‚îÄ‚îÄ templates/
      ‚îî‚îÄ‚îÄ contrat_modele.html

üîß 1. G√©n√©ration du contrat PDF

services/contract_generator.py :

from jinja2 import Environment, FileSystemLoader
from weasyprint import HTML
import tempfile

def generate_contract_pdf(data: dict) -> str:
    env = Environment(loader=FileSystemLoader("templates"))
    template = env.get_template("contrat_modele.html")
    html_content = template.render(data)
    
    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=".pdf")
    HTML(string=html_content).write_pdf(temp_file.name)
    return temp_file.name

üîß 2. Validation et g√©n√©ration automatique

routes/loans.py :

from fastapi import APIRouter, HTTPException
from services.contract_generator import generate_contract_pdf
from services.s3_storage import upload_to_s3
from services.mailer import send_mail
from db import get_loan_by_id, update_loan_status

router = APIRouter()

@router.patch("/api/loans/{loan_id}/validate")
def validate_loan(loan_id: int):
    loan = get_loan_by_id(loan_id)
    if not loan:
        raise HTTPException(404, "Loan not found")

    update_loan_status(loan_id, "approved")

    pdf_path = generate_contract_pdf({
        "nom": loan.user.name,
        "montant": loan.amount,
        "taux": loan.rate,
        "duree": loan.duration_months,
        "date": "2025-11-04"
    })

    contract_url = upload_to_s3(pdf_path, f"contrats/contrat_{loan.id}.pdf")

    send_mail(
        to=loan.user.email,
        subject="Votre contrat de pr√™t est disponible",
        body=f"Bonjour {loan.user.name},\n\nVotre contrat est pr√™t. T√©l√©chargez-le ici : {contract_url}\nSignez-le puis renvoyez-le √† contrat@tonsite.com."
    )

    return {"message": "Contrat g√©n√©r√©", "contract_url": contract_url}

üîß 3. Envoi du contrat sign√©

Deux options :

Option 1 : Upload via dashboard
@app.post("/api/loans/{loan_id}/upload_signed")
def upload_signed_contract(loan_id: int, file: UploadFile):
    path = f"/tmp/signed_{loan_id}.pdf"
    with open(path, "wb") as f:
        f.write(file.file.read())

    url = upload_to_s3(path, f"signed/signed_{loan_id}.pdf")
    update_loan_status(loan_id, "signed", signed_url=url)
    return {"message": "Contrat sign√© re√ßu", "url": url}

Option 2 : Envoi par e-mail

Utilise services.mailer.py avec un SMTP gratuit (Mailjet, Gmail API, etc.).
Tous les contrats sign√©s re√ßus sont ensuite t√©l√©charg√©s et archiv√©s manuellement.

üñ•Ô∏è Frontend (React / Vercel)
Page Dashboard
{loans.map(loan => (
  <Card key={loan.id}>
    <h3>Contrat #{loan.id}</h3>
    {loan.status === "approved" && (
      <>
        <a href={loan.contract_url} target="_blank" rel="noreferrer">T√©l√©charger le contrat</a>
        <p>Veuillez le signer et le renvoyer √† <b>contrat@tonsite.com</b></p>
        <UploadButton loanId={loan.id} />
      </>
    )}
    {loan.status === "signed" && (
      <p>‚úÖ Contrat sign√© re√ßu</p>
    )}
  </Card>
))}

üí¨ S√©curit√© & conformit√©

Toutes les actions sont li√©es au compte connect√© (JWT).

Contrats stock√©s sur S3 avec permissions priv√©es.

Les URLs partag√©es sont temporaires.

L‚Äôemail d‚Äôenvoi est enregistr√© dans les logs pour tra√ßabilit√©.

Conforme RGPD si tu respectes l‚Äôeffacement √† la demande et le stockage chiffr√©.

‚úÖ R√©sultat final

Le client re√ßoit automatiquement un contrat PDF clair apr√®s validation.

Il peut le t√©l√©charger depuis son espace client.

Il signe manuellement et le renvoie par mail ou via le site.

Le document sign√© devient visible pour les deux parties.

Le tout est 100 % gratuit et enti√®rement h√©berg√© sur ton infrastructure (Render + Vercel).