PROMPT Ã€ ENVOYER Ã€ REPLIT (GHOSTWRITER)

Tu es un expert backend Node.js/Express. Corrige ma configuration E2E afin que le front (Vercel) et le backend (Render) fonctionnent parfaitement ensemble avec cookies, sessions et CSRF en cross-domain.

ğŸ¯ Objectif

Faire fonctionner les requÃªtes front â†’ backend depuis le domaine :

Frontend : https://altusfinancesgroup.com

Backend : https://api.altusfinancesgroup.com

Sans erreur :

âŒ â€œVotre session a expirÃ©â€

âŒ Cookies non envoyÃ©s

âŒ CSRF token invalide

âŒ RequÃªtes vers le mauvais domaine (altusfinancesgroup.com/api/...)

ğŸ”§ I. Voici ce que tu dois corriger :
1. CORS

Ajouter dans connectSrc, scriptSrc, imgSrc, defaultSrc, etc. â†’ https://altusfinancesgroup.com
 ET https://api.altusfinancesgroup.com

Remplacer dans CSP :

connectSrc: ["'self'", "https://altusfinancesgroup.com", "https://api.altusfinancesgroup.com"],

2. Cookies de session

Dans la config session, appliquer exactement :

cookie: {
  httpOnly: true,
  secure: true,
  sameSite: "none",
  domain: ".altusfinancesgroup.com",
  maxAge: 1000 * 60 * 60 * 24 * 7
}


âš ï¸ Le domaine doit Ãªtre .altusfinancesgroup.com (avec le point).

3. CSRF

Dans lâ€™endpoint /api/csrf-token, vÃ©rifier que :

le cookie CSRF est envoyÃ© avec sameSite:none, secure:true

la rÃ©ponse inclut bien le header :

Access-Control-Allow-Credentials: true


Et dans CORS :

credentials: true

4. Header connect-src (CSP)

Il doit autoriser le backend depuis le front :

connectSrc: [
  "'self'",
  "https://altusfinancesgroup.com",
  "https://api.altusfinancesgroup.com"
],

5. IMPORTANT : Injection de variable d'environnement

Dans le frontend, remplacer lâ€™URL :

âŒ Mauvais :
window.location.origin + '/api/...
â†’ En production cela donne : https://altusfinancesgroup.com/api/...

âœ… Corriger pour qu'il utilise :
https://api.altusfinancesgroup.com/api/...

Ghostwriter doit :

vÃ©rifier lâ€™utilisation de VITE_API_BASE_URL ou Ã©quivalent

si absent â†’ ajouter un fichier .env.production dans le front :

VITE_API_BASE_URL=https://api.altusfinancesgroup.com


vÃ©rifier que les appels utilisent :

const api = import.meta.env.VITE_API_BASE_URL;

ğŸ§ª 6. Test Ã  effectuer automatiquement

Ghostwriter doit valider :

GET https://api.altusfinancesgroup.com/api/csrf-token
â†’ Cookie + header OK

GET https://api.altusfinancesgroup.com/api/unread-count
â†’ Cookie transmis

POST /api/transfers/initiate
â†’ NE DOIT PLUS renvoyer â€œvotre session a expirÃ©â€

ğŸ“Œ RÃ©sumÃ© clair pour toi :

Corrige :

CSP

CORS

Cookies session

Cookie CSRF

Domaine des requÃªtes API

Injection environnement Vercel

Fais toutes ces corrections dans les fichiers backend (Express) ET frontend si nÃ©cessaire.
Ensuite, montre-moi dans la console ce qui a Ã©tÃ© changÃ©.