Prompt Ã  envoyer Ã  Replit :

âš™ï¸ Contexte :
Mon projet utilise un frontend hÃ©bergÃ© sur Vercel (https://altusfinancegroup.com) et un backend Express/Node.js hÃ©bergÃ© sur Render (https://api.altusfinancegroup.com), avec PostgreSQL.

Lâ€™authentification fonctionne jusquâ€™Ã  la validation de lâ€™email :
le code est acceptÃ©, mais lâ€™utilisateur nâ€™est pas redirigÃ© vers son tableau de bord et nâ€™est pas authentifiÃ© (aucune session ou cookie actif).

Je veux que tu corriges tout ce qui empÃªche la connexion automatique aprÃ¨s validation de lâ€™email, en respectant les bonnes pratiques de sÃ©curitÃ© (CSRF, cookies HTTP-only, CORS sÃ©curisÃ©, etc.).

ğŸ› ï¸ Objectif prÃ©cis :

AprÃ¨s que lâ€™utilisateur entre son code de vÃ©rification reÃ§u par email,
â†’ le backend doit valider le code,
â†’ crÃ©er une session sÃ©curisÃ©e (cookie HTTP-only) ou un JWT,
â†’ puis renvoyer une rÃ©ponse claire au frontend indiquant que lâ€™utilisateur est connectÃ©.

Le frontend doit automatiquement rediriger vers le tableau de bord (/dashboard) aprÃ¨s validation rÃ©ussie.

Le cookie/session doit fonctionner entre :

https://altusfinancegroup.com (frontend)

https://api.altusfinancegroup.com (backend)

ğŸ”’ SpÃ©cifications techniques Ã  appliquer :
ğŸ”§ 1. Configuration CORS (backend)
import cors from "cors";

app.use(cors({
  origin: ["https://altusfinancegroup.com"],
  credentials: true,
}));

ğŸª 2. Cookie de session (backend)

Quand tu crÃ©es la session :

res.cookie("session", token, {
  httpOnly: true,
  secure: true,
  sameSite: "none",
  domain: ".altusfinancegroup.com", // essentiel pour le cross-domain
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 jours
});

ğŸ” 3. Route de vÃ©rification de code (/api/auth/verify-email ou similaire)

VÃ©rifie le code dans la base de donnÃ©es.

Si correct :

mets emailVerified = true

crÃ©e une session JWT ou cookie

renvoie une rÃ©ponse JSON :

{ "success": true, "message": "Email vÃ©rifiÃ©", "redirect": "/dashboard" }

ğŸŒ 4. Frontend (React / Next.js)

Dans le composant qui gÃ¨re la validation du code :

const handleVerify = async () => {
  const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/auth/verify-email`, {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code }),
  });

  const data = await res.json();
  if (data.success) {
    window.location.href = data.redirect || "/dashboard";
  } else {
    toast.error(data.message || "Ã‰chec de la vÃ©rification");
  }
};

âš ï¸ VÃ©rifications Ã  faire aprÃ¨s correction

Le cookie session doit apparaÃ®tre dans les DevTools > Application > Cookies > api.altusfinancegroup.com.

AprÃ¨s validation, tu dois Ãªtre redirigÃ© automatiquement vers /dashboard.

Si tu actualises la page, tu restes connectÃ© (le cookie est valide).