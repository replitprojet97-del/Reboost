NSTRUCTION STRICTE ‚Äì NE PAS ANALYSER, NE PAS CONCLURE, NE PAS OPTIMISER

Tu dois UNIQUEMENT appliquer les modifications ci-dessous, exactement comme d√©crites.

‚ùå Ne pas proposer d‚Äôalternative
‚ùå Ne pas expliquer
‚ùå Ne pas modifier d‚Äôautres fichiers
‚ùå Ne pas changer la logique m√©tier

CONTEXTE

Le bug en production vient d‚Äôun parsing JSON non s√©curis√© dans la gestion CSRF et des erreurs API.
Certaines routes (/api/csrf-token, erreurs 401/403) renvoient du HTML en production.
Le frontend tente de parser ce HTML avec res.json() ce qui provoque :

Unexpected token < in JSON at position 0

FICHIER √Ä MODIFIER

client/src/lib/queryClient.ts

MODIFICATION 1 ‚Äî S√©curiser le parsing JSON dans getCsrfToken()
üî¥ CODE ACTUEL (√Ä REMPLACER)
if (res.ok) {
  const contentType = res.headers.get("content-type");
  if (contentType && contentType.includes("application/json")) {
    const data = await res.json();
    csrfToken = data.csrfToken;
    console.log('[CSRF] Token acquired successfully');
    return csrfToken!;
  } else {
    console.error('[CSRF] Received non-JSON response:', contentType);
    const text = await res.text();
    console.error('[CSRF] Response preview:', text.substring(0, 100));
  }
}

‚úÖ NOUVEAU CODE (REMPLACEMENT EXACT)
if (res.ok) {
  const contentType = res.headers.get("content-type");
  if (contentType && contentType.includes("application/json")) {
    const data = await res.json();
    csrfToken = data.csrfToken;
    return csrfToken!;
  } else {
    const text = await res.text();
    console.error('[CSRF] Non-JSON response:', text.substring(0, 200));
    return '';
  }
}

MODIFICATION 2 ‚Äî Ne pas ajouter le header CSRF si le token est vide
üî¥ CODE ACTUEL
const token = await getCsrfToken();
if (token) {
  headers['X-CSRF-Token'] = token;
}


‚ö†Ô∏è Si ce code existe d√©j√† sous cette forme, ne rien changer.

‚ùå Ne jamais forcer X-CSRF-Token si token === ''

MODIFICATION 3 ‚Äî S√©curiser le parsing JSON dans throwIfResNotOk()
üî¥ CODE ACTUEL (PARTIE ERREUR)
errorData = await res.json();

‚úÖ REMPLACER PAR
const contentType = res.headers.get("content-type");
if (contentType && contentType.includes("application/json")) {
  errorData = await res.json();
} else {
  errorData = {};
}

R√àGLES STRICTES

Ne pas modifier les routes backend

Ne pas modifier SendPulse

Ne pas modifier Resend

Ne pas changer la logique m√©tier

Ne pas refactorer

Ne pas ajouter de nouvelles fonctionnalit√©s

OBJECTIF

Emp√™cher toute tentative de res.json() sur une r√©ponse HTML

√âliminer d√©finitivement l‚Äôerreur Unexpected token <

Permettre √† la requ√™te POST /api/loans d‚Äôatteindre Render en production

SORTIE ATTENDUE

Appliquer les modifications

Sauvegarder le fichier

Ne pas commenter

Ne pas expliquer

FIN DE L‚ÄôINSTRUCTION